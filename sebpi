#!/bin/bash

COMMAND=$1
SEBPI_SETUP_FILE_NAME="sebpi-setup.sh"
RASPBERRY_PI_IP_ADDRESS="192.168.1.2"

function usage() {
    echo "Usage: sebpi <install|setup>"
    return -1
}

function confirm() {
    # call with a prompt string or use a default
    read -r -p "${1:-Are you sure? [y/N]} " response
    case "$response" in
        [yY][eE][sS]|[yY]) 
            return 0
            ;;
        *)
            return -1
            ;;
    esac
}

function install() {
    if [[ "$#" -ne 2 ]]; then
        echo "Usage: sebpi install <img_file> <dev_disk>"
        echo "Example: sebpi install raspbian-stretch-lite.img /dev/rdisk3"
        return -1
    fi

    IMG_FILE="$1"
    DEV_DISK="$2"

    confirm "WARNING: This will erase completely the contents of the SD card at $DEV_DISK. Do you want to proceed? [y/N]" || return -1

    sudo diskutil eraseDisk FAT32 RASPBIAN MBRFormat ${DEV_DISK/r/} || return -1
    sleep 5
    diskutil unmountdisk ${DEV_DISK/r/} || return -1
    sleep 5
    sudo dd if="$IMG_FILE" of=$DEV_DISK bs=1m || return -1
    sleep 5
    touch /Volumes/boot/ssh
    cp "$SEBPI_SETUP_FILE_NAME" /Volumes/boot
    diskutil unmountdisk ${DEV_DISK/r/} || return -1
    sed -i '' "/^$RASPBERRY_PI_IP_ADDRESS /d" ~/.ssh/known_hosts

    echo "Done! To continue:"
    echo "  1. Insert your microSD card in the Raspberry Pi and turn it on."
    echo "  2. Wait 5 minutes"
    echo "  3. Come back to this terminal here and run 'sebpi setup'"

    return 0
}

function setup() {    
    # run /boot/sebpi-install.sh on ssh
    ##
    sed -i '' "/^$RASPBERRY_PI_IP_ADDRESS /d" ~/.ssh/known_hosts
    echo "Running sebpi-install.sh on the Raspberry Pi..."
    ssh -t pi@$RASPBERRY_PI_IP_ADDRESS "sudo /boot/$SEBPI_SETUP_FILE_NAME"
    echo "Please change the password (default: raspberry)"
    ssh -t pi@$RASPBERRY_PI_IP_ADDRESS passwd

    return 0
}

case "$COMMAND" in
    install)
        install $2 $3;
        ;;
    setup)
        setup;
        ;;
    *)
        usage;
        ;;
esac
